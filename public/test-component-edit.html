<!DOCTYPE html>
<html>
<head>
    <title>Test Component Editing</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        button { padding: 10px 15px; margin: 5px; background: #007cba; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #005a87; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Test Component Editing via HTTP Endpoints</h1>
    
    <div class="test-section">
        <h2>1. Read Component</h2>
        <button onclick="readComponent()">Read Debug Component</button>
        <div id="readResult"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Save Component</h2>
        <button onclick="saveComponent()">Save Modified Component</button>
        <div id="saveResult"></div>
    </div>
    
    <div class="test-section">
        <h2>3. List All Components</h2>
        <button onclick="listComponents()">List Components</button>
        <div id="listResult"></div>
    </div>

    <script>
        function log(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            const className = isError ? 'error' : 'success';
            element.innerHTML = `<div class="${className}">${new Date().toLocaleTimeString()}: ${message}</div>` + element.innerHTML;
        }

        async function readComponent() {
            try {
                const response = await fetch('/api/flow/component/debug_component');
                const result = await response.json();
                
                if (result.success) {
                    log('readResult', `Component read successfully. HTML length: ${result.value.data.length} characters`);
                    console.log('Component data:', result.value.data);
                } else {
                    log('readResult', `Error: ${result.error}`, true);
                }
            } catch (error) {
                log('readResult', `Network error: ${error.message}`, true);
            }
        }

        async function saveComponent() {
            try {
                // Create a modified version of the component
                const modifiedHtml = `<script total>

	exports.id = 'debug_component';
	exports.name = 'Debug Component (Modified)';
	exports.icon = 'ti ti-bug';
	exports.author = 'API';
	exports.version = '1.1';
	exports.group = 'Test';
	exports.config = {};
	exports.inputs = [{ id: 'input', name: 'Input' }];
	exports.outputs = [{ id: 'output', name: 'Output' }, { id: 'error', name: 'Error' }];

	exports.make = function(instance, config) {

		instance.message = function($) {
			var data = $.data;
			
			// Execute user-provided code
			try {
				console.log("Debug component (MODIFIED)!", data);
				$.send("output", data);
			} catch (e) {
				console.error('Error in component debug_component:', e);
				$.send('error', { error: e.message, originalData: data });
			}
		};

		instance.configure = function() {
			// "config" is changed
		};

		instance.close = function() {
			// this instance is closed
		};

		instance.vary = function(type) {
			// @type {String} variables|variables2|secrets
			// FlowStream variables are changed
		};

		instance.configure();

	};

</script>

<readme>
# Debug Component (Modified)

This component has been modified via HTTP API.
</readme>

<settings>
<div class="padding">
	<div class="b">Modified Component Settings</div>
	<hr />
	<div class="message message-info">
		<i class="ti ti-info-circle"></i>
		This component was modified via HTTP API.
	</div>
</div>
</settings>

<style>
	.CLASS footer { padding: 10px; font-size: 12px; }
</style>

<script>
	TOUCH(function(exports, reinit) {
		var name = exports.name + ' --> ' + exports.id;
		console.log(name, 'initialized' + (reinit ? ' : UPDATE' : ''));
	});
</script>

<body>
	<header>
		<i class="$ICON"></i>$NAME
	</header>
	<footer>Modified via HTTP API</footer>
</body>`;

                const response = await fetch('/api/flow/component/debug_component', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ data: modifiedHtml })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log('saveResult', `Component saved successfully. Name: ${result.value.component.name}, Version: ${result.value.component.version}`);
                } else {
                    log('saveResult', `Error: ${result.error}`, true);
                }
            } catch (error) {
                log('saveResult', `Network error: ${error.message}`, true);
            }
        }

        async function listComponents() {
            try {
                const response = await fetch('/api/flow/components');
                const result = await response.json();
                
                if (result.success) {
                    const components = result.value.components;
                    log('listResult', `Found ${components.length} components:`);
                    components.forEach(comp => {
                        log('listResult', `- ${comp.name} (${comp.id}) - ${comp.group} - v${comp.version}`);
                    });
                } else {
                    log('listResult', `Error: ${result.error}`, true);
                }
            } catch (error) {
                log('listResult', `Network error: ${error.message}`, true);
            }
        }
    </script>
</body>
</html> 